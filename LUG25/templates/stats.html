{% extends "base_app.html" %}

{% block title %}Dashboard - Adelchi Group{% endblock %}

{% block extra_css %}
<style>
    /* COPIA CSS */
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1 class="page-title">📊 Dashboard Adelchi</h1>
    <div class="welcome-back">Bentornato, <strong>{{ current_user.username }}</strong>! 👋</div>
</div>

<!-- Dashboard Grid -->
<div class="dashboard-grid">
    <!-- ... resto ... -->
</div>

{% endblock %}

{% block extra_js %}
<script>
    /* JAVASCRIPT */
</script>
{% endblock %}


<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📊 Dashboard Adelchi</h1>
            <div class="welcome-back">
                Bentornato, <strong>{{ current_user.username }}</strong>! 👋
            </div>

            <div class="nav-actions">
                <a href="/" class="nav-btn">🏠 Home</a>
                <a href="/wallet" class="nav-btn primary">💳 Wallet ADG</a>
                <a href="/mining" class="nav-btn">⛏️ Mining</a>
                <a href="/logout" class="nav-btn">🚪 Logout</a>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">

            <!-- Statistiche Sito -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">👥</span>
                        Statistiche Sito
                    </div>
                </div>
                <div class="stat-value">{{ visit_count }}</div>
                <div class="stat-label">Visitatori Totali</div>

                <div class="system-status">
                    <div class="status-indicator"></div>
                    <span>Sistema Online</span>
                </div>
            </div>

            <!-- ADG Overview -->
            <div class="dashboard-card adg-overview">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">💎</span>
                        ADG Token Overview
                    </div>
                </div>

                <div class="adg-stats">
                    <div class="adg-stat">
                        <div class="adg-stat-icon">💰</div>
                        <div class="adg-stat-value" id="totalSupply">12,450</div>
                        <div class="adg-stat-label">Total Supply</div>
                    </div>
                    <div class="adg-stat">
                        <div class="adg-stat-icon">👤</div>
                        <div class="adg-stat-value" id="totalHolders">{{ visit_count // 50 + 15 }}</div>
                        <div class="adg-stat-label">Holders</div>
                    </div>
                    <div class="adg-stat">
                        <div class="adg-stat-icon">📈</div>
                        <div class="adg-stat-value">+{{ ((visit_count % 100) + 20) }}</div>
                        <div class="adg-stat-label">24h Volume</div>
                    </div>
                    <div class="adg-stat">
                        <div class="adg-stat-icon">⛏️</div>
                        <div class="adg-stat-value" id="miningStatus">OFF</div>
                        <div class="adg-stat-label">Mining Status</div>
                    </div>
                </div>

                <div class="mining-toggle">
                    <button class="toggle-btn disabled" id="miningToggle" onclick="toggleMining()">
                        🔴 Mining Disattivato
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card quick-actions">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">⚡</span>
                        Azioni Rapide
                    </div>
                </div>

                <div class="actions-grid">
                    <a href="/wallet" class="action-btn">
                        <div class="action-icon">💳</div>
                        <div class="action-title">Visualizza Wallet</div>
                        <div class="action-desc">Controlla balance e transazioni</div>
                    </a>
                    <a href="/mining" class="action-btn">
                        <div class="action-icon">⛏️</div>
                        <div class="action-title">Mining Pool</div>
                        <div class="action-desc">Gestisci i tuoi miners</div>
                    </a>
                    <a href="/finanza" class="action-btn">
                        <div class="action-icon">₿</div>
                        <div class="action-title">Crypto Trading</div>
                        <div class="action-desc">Esplora DeFi e blockchain</div>
                    </a>
                    <a href="/life-science" class="action-btn">
                        <div class="action-icon">🧬</div>
                        <div class="action-title">Life Science</div>
                        <div class="action-desc">Biotecnologie e AI</div>
                    </a>
                </div>
            </div>

            <!-- Live Feed -->
            <div class="dashboard-card live-feed">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">📡</span>
                        Live Feed
                    </div>
                </div>

                <div id="liveFeed">
                    <div class="feed-item">
                        <div class="feed-time">{{ recent_visitors[0].timestamp[:16] if recent_visitors else 'Ora' }}</div>
                        <div class="feed-message">🎉 Nuovo utente registrato: {{ recent_visitors[0].user if recent_visitors else 'User123' }}</div>
                    </div>
                    <div class="feed-item">
                        <div class="feed-time">{{ recent_visitors[1].timestamp[:16] if recent_visitors|length > 1 else 'Poco fa' }}</div>
                        <div class="feed-message">💰 +1 ADG reward distribuito</div>
                    </div>
                    <div class="feed-item">
                        <div class="feed-time">{{ recent_visitors[2].timestamp[:16] if recent_visitors|length > 2 else 'Adesso' }}</div>
                        <div class="feed-message">🔧 Sistema aggiornato con successo</div>
                    </div>
                </div>
            </div>

            <!-- Visitatori Recenti -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">👁️</span>
                        Visitatori Recenti
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">Ultimi {{ recent_visitors|length }}</div>
                </div>

                <div class="visitors-list">
                    {% for visitor in recent_visitors %}
                    <div class="visitor-item">
                        <div class="visitor-info">
                            <span class="visitor-user">{{ visitor.user }}</span>
                            <span class="visitor-time">{{ visitor.timestamp[11:16] }}</span>
                        </div>
                        <div class="visitor-details">
                            IP: {{ visitor.ip[:15] }}... | {{ visitor.user_agent[:30] }}...
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>

    <script>
        let miningEnabled = false;

        function toggleMining() {
            const btn = document.getElementById('miningToggle');
            const status = document.getElementById('miningStatus');

            // Simula chiamata API
            fetch('/admin/toggle-mining', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    miningEnabled = data.mining_enabled;

                    if (miningEnabled) {
                        btn.textContent = '🟢 Mining Attivato';
                        btn.className = 'toggle-btn';
                        status.textContent = 'ON';
                        status.style.color = '#10B981';
                        showNotification('⛏️ Mining Pool Attivato!');
                    } else {
                        btn.textContent = '🔴 Mining Disattivato';
                        btn.className = 'toggle-btn disabled';
                        status.textContent = 'OFF';
                        status.style.color = '#EF4444';
                        showNotification('🛑 Mining Pool Disattivato');
                    }
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                showNotification('❌ Errore nel toggle mining');
            });
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: linear-gradient(45deg, #10B981, #34D399);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                font-weight: 600;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Aggiorna statistiche in tempo reale
        function updateStats() {
            const totalSupply = document.getElementById('totalSupply');
            if (totalSupply) {
                const current = parseInt(totalSupply.textContent.replace(',', ''));
                const newValue = current + Math.floor(Math.random() * 5);
                totalSupply.textContent = newValue.toLocaleString();
            }
        }

        // Aggiungi feed items casuali
        function addFeedItem() {
            const feed = document.getElementById('liveFeed');
            const messages = [
                '💰 Nuova transazione ADG completata',
                '🔐 Nuovo wallet creato',
                '⛏️ Blocco minato con successo',
                '👤 Utente si è connesso',
                '📊 Statistiche aggiornate',
                '🚀 Sistema ottimizzato'
            ];

            const now = new Date();
            const timeStr = now.toTimeString().slice(0, 5);

            const newItem = document.createElement('div');
            newItem.className = 'feed-item';
            newItem.innerHTML = `
                <div class="feed-time">${timeStr}</div>
                <div class="feed-message">${messages[Math.floor(Math.random() * messages.length)]}</div>
            `;

            feed.insertBefore(newItem, feed.firstChild);

            // Mantieni solo gli ultimi 5 items
            while (feed.children.length > 5) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Animazioni al caricamento
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.dashboard-card');

            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                card.style.transition = 'all 0.6s ease';

                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 150);
            });

            // Avvia aggiornamenti periodici
            setInterval(updateStats, 10000); // Ogni 10 secondi
            setInterval(addFeedItem, 15000); // Ogni 15 secondi
        });
    </script>
</body>
</html>