{% extends "base_app.html" %}

{% block title %}Modifica Nota - Adelchi Group{% endblock %}

{% block content %}
<div class="glass-card" style="max-width: 800px; margin: 0 auto;">
    <h1 class="page-title">âœï¸ Modifica Nota</h1>
    <p class="page-subtitle">Aggiorna la tua nota</p>

    <!-- Meta Info -->
    <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px; margin-bottom: 2rem; font-size: 0.9rem; opacity: 0.8;">
        <strong>ğŸ“… Creata:</strong> {{ note.created_at.strftime('%d/%m/%Y %H:%M') }}<br>
        <strong>ğŸ”„ Ultima modifica:</strong> {{ note.updated_at.strftime('%d/%m/%Y %H:%M') }}
    </div>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div style="background: rgba(72, 187, 120, 0.3); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid rgba(72, 187, 120, 0.5);">
                {% for message in messages %}
                    {{ message }}
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="POST" action="/edit_note/{{ note.id }}">
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Titolo *</label>
            <input type="text" name="title" value="{{ note.title }}" required
                   style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Contenuto *</label>
            <textarea name="content" rows="6" required
                      style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem; resize: vertical;">{{ note.content }}</textarea>
        </div>

        <!-- UPLOAD IMMAGINI -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ“ Allega Immagini</label>
            <input type="file" id="noteImages" multiple accept="image/*"
                   style="width: 100%; padding: 0.8rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
            <div id="imagePreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 1rem;"></div>
            <small style="opacity: 0.7; display: block; margin-top: 0.5rem;">ğŸ’¡ Puoi anche incollare immagini con Ctrl+V</small>
        </div>

        <!-- Immagini giÃ  allegate -->
        {% if note.attached_files %}
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ–¼ï¸ Immagini Allegate</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem;">
                {% for note_file in note.attached_files %}
                <div style="position: relative;">
                    <img src="/uploads/{{ note_file.file.filename }}"
                         style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;">
                    <button type="button" onclick="removeAttachment({{ note_file.id }})"
                            style="position: absolute; top: 5px; right: 5px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 0.7rem;">âœ•</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tipo Nota</label>
                <select name="note_type" id="note_type" style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                    <option value="text" {% if note.note_type == 'text' %}selected{% endif %}>ğŸ“ Testo</option>
                    <option value="task" {% if note.note_type == 'task' %}selected{% endif %}>âœ… Task</option>
                    <option value="idea" {% if note.note_type == 'idea' %}selected{% endif %}>ğŸ’¡ Idea</option>
                    <option value="link" {% if note.note_type == 'link' %}selected{% endif %}>ğŸ”— Link</option>
                </select>
            </div>

            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">PrioritÃ </label>
                <select name="priority" style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                    <option value="low" {% if note.priority == 'low' %}selected{% endif %}>Bassa</option>
                    <option value="normal" {% if note.priority == 'normal' %}selected{% endif %}>Normale</option>
                    <option value="high" {% if note.priority == 'high' %}selected{% endif %}>Alta</option>
                    <option value="urgent" {% if note.priority == 'urgent' %}selected{% endif %}>Urgente</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tag (separati da virgola)</label>
            <input type="text" name="tags" value="{{ note.tags or '' }}" placeholder="lavoro, importante, progetto..."
                   style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ“ Assegna a Progetto</label>
            <select name="project_id" style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                <option value="">-- Nessun progetto (nota personale) --</option>
                {% for project in projects %}
                <option value="{{ project.id }}" {% if note.project_id == project.id %}selected{% endif %}>
                    {{ project.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div id="urlGroup" style="{% if note.note_type != 'link' %}display: none;{% endif %} margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">URL Esterno</label>
            <input type="url" name="external_url" value="{{ note.external_url or '' }}" placeholder="https://..."
                   style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
        </div>

        <div id="dueDateGroup" style="{% if note.note_type != 'task' %}display: none;{% endif %} margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Scadenza</label>
            <input type="date" name="due_date" value="{{ note.due_date.strftime('%Y-%m-%d') if note.due_date else '' }}"
                   style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
        </div>

        {% if note.note_type == 'task' %}
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px;">
                <input type="checkbox" id="completed" name="completed" {% if note.completed %}checked{% endif %} style="width: 20px; height: 20px;">
                <label for="completed" style="margin: 0; cursor: pointer;">âœ… Segna come completata</label>
            </div>
        </div>
        {% endif %}

        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button type="submit" style="background: linear-gradient(45deg, #E7D454, #F4E869); color: #005B94; padding: 1rem 2rem; border: none; border-radius: 25px; font-weight: 700; cursor: pointer;">
                ğŸ’¾ Salva
            </button>
            <a href="/notes" style="background: rgba(255,255,255,0.2); color: white; padding: 1rem 2rem; border-radius: 25px; font-weight: 700; text-decoration: none; display: inline-block;">
                âŒ Annulla
            </a>
            <button type="button" onclick="deleteNote()" style="background: #EF4444; color: white; padding: 1rem 2rem; border: none; border-radius: 25px; font-weight: 700; cursor: pointer;">
                ğŸ—‘ï¸ Elimina
            </button>
        </div>
    </form>
</div>

<script>
// Tipo nota dinamico
document.getElementById('note_type').addEventListener('change', function() {
    document.getElementById('urlGroup').style.display = this.value === 'link' ? 'block' : 'none';
    document.getElementById('dueDateGroup').style.display = this.value === 'task' ? 'block' : 'none';
});

// Preview immagini selezionate
document.getElementById('noteImages').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    Array.from(e.target.files).forEach(file => {
        const div = document.createElement('div');
        div.style = 'position: relative;';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.style = 'width: 100%; height: 100px; object-fit: cover; border-radius: 8px;';
        div.appendChild(img);
        preview.appendChild(div);

        // Upload automatico
        uploadImageToNote(file);
    });
});

// Paste da clipboard
document.addEventListener('paste', function(e) {
    const items = e.clipboardData.items;
    for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
            const file = item.getAsFile();
            uploadImageToNote(file);
            showAlert('ğŸ“ Immagine incollata e caricata!', 'success');
        }
    }
});

// Upload immagine
function uploadImageToNote(file) {
    const formData = new FormData();
    formData.append('image', file);

    fetch('/note/{{ note.id }}/attach_image', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showAlert('âœ… Immagine allegata!', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(() => showAlert('âŒ Errore upload', 'error'));
}

// Rimuovi allegato
function removeAttachment(attachmentId) {
    if (!confirm('Rimuovere questa immagine?')) return;

    fetch(`/note/attachment/${attachmentId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showAlert('âœ… Immagine rimossa', 'success');
            setTimeout(() => location.reload(), 800);
        }
    });
}

// Elimina nota
function deleteNote() {
    if (confirm('âš ï¸ Eliminare questa nota?')) {
        fetch('/delete_note/{{ note.id }}', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('âœ… Nota eliminata', 'success');
                setTimeout(() => window.location.href = '/notes', 800);
            }
        });
    }
}

// Alert helper
function showAlert(msg, type) {
    const alert = document.createElement('div');
    alert.textContent = msg;
    alert.style = `position: fixed; top: 2rem; right: 2rem; background: ${type === 'success' ? '#10B981' : '#EF4444'}; color: white; padding: 1rem 1.5rem; border-radius: 10px; font-weight: 600; z-index: 9999; animation: slideIn 0.3s;`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}
</script>
{% endblock %}