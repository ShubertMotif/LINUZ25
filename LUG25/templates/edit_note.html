{% extends "base_app.html" %}

{% block title %}Modifica Nota - Adelchi Group{% endblock %}

{% block content %}
<div class="glass-card" style="max-width: 800px; margin: 0 auto;">
    <h1 class="page-title">✏️ Modifica Nota</h1>
    <p class="page-subtitle">Aggiorna la tua nota</p>

    <!-- Meta Info -->
    <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px; margin-bottom: 2rem; font-size: 0.9rem; opacity: 0.8;">
        <strong>📅 Creata:</strong> {{ note.created_at.strftime('%d/%m/%Y %H:%M') }}<br>
        <strong>🔄 Ultima modifica:</strong> {{ note.updated_at.strftime('%d/%m/%Y %H:%M') }}
    </div>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div style="background: rgba(72, 187, 120, 0.3); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px solid rgba(72, 187, 120, 0.5);">
                {% for message in messages %}
                    {{ message }}
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="POST" action="/edit_note/{{ note.id }}">
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Titolo *</label>
            <input type="text" name="title" value="{{ note.title }}" required
                   style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Contenuto *</label>
            <textarea name="content" rows="6" required
                      style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem; resize: vertical;">{{ note.content }}</textarea>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tipo Nota</label>
                <select name="note_type" id="note_type" style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                    <option value="text" {% if note.note_type == 'text' %}selected{% endif %}>📝 Testo</option>
                    <option value="task" {% if note.note_type == 'task' %}selected{% endif %}>✅ Task</option>
                    <option value="idea" {% if note.note_type == 'idea' %}selected{% endif %}>💡 Idea</option>
                    <option value="link" {% if note.note_type == 'link' %}selected{% endif %}>🔗 Link</option>
                </select>
            </div>

            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Priorità</label>
                <select name="priority" style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                    <option value="low" {% if note.priority == 'low' %}selected{% endif %}>Bassa</option>
                    <option value="normal" {% if note.priority == 'normal' %}selected{% endif %}>Normale</option>
                    <option value="high" {% if note.priority == 'high' %}selected{% endif %}>Alta</option>
                    <option value="urgent" {% if note.priority == 'urgent' %}selected{% endif %}>Urgente</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tag (separati da virgola)</label>
            <input type="text" name="tags" value="{{ note.tags or '' }}" placeholder="lavoro, importante, progetto..."
                   style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
        </div>

        <!-- ⭐ DROPDOWN PROGETTO -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">📁 Assegna a Progetto</label>
            <select name="project_id" style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                <option value="">-- Nessun progetto (nota personale) --</option>
                {% for project in projects %}
                <option value="{{ project.id }}" {% if note.project_id == project.id %}selected{% endif %}>
                    {{ project.name }}
                </option>
                {% endfor %}
            </select>
            <small style="opacity: 0.7; font-size: 0.85rem; display: block; margin-top: 0.5rem;">
                {% if note.project_id %}
                Attualmente in: <strong>{{ note.project.name }}</strong>
                {% else %}
                Nota personale - seleziona un progetto per condividerla
                {% endif %}
            </small>
        </div>

        <!-- URL esterno (solo per link) -->
        <div id="urlGroup" style="{% if note.note_type != 'link' %}display: none;{% endif %} margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">URL Esterno</label>
            <input type="url" name="external_url" value="{{ note.external_url or '' }}" placeholder="https://..."
                   style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
        </div>

        <!-- Scadenza (solo per task) -->
        <div id="dueDateGroup" style="{% if note.note_type != 'task' %}display: none;{% endif %} margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Scadenza</label>
            <input type="date" name="due_date" value="{{ note.due_date.strftime('%Y-%m-%d') if note.due_date else '' }}"
                   style="width: 100%; padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
        </div>

        <!-- Completamento task -->
        {% if note.note_type == 'task' %}
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3);">
                <input type="checkbox" id="completed" name="completed" {% if note.completed %}checked{% endif %} style="width: 20px; height: 20px; cursor: pointer;">
                <label for="completed" style="margin: 0; cursor: pointer; flex: 1;">✅ Segna come completata</label>
            </div>
        </div>
        {% endif %}

        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button type="submit" style="background: linear-gradient(45deg, #E7D454, #F4E869); color: #005B94; padding: 1rem 2rem; border: none; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                💾 Salva Modifiche
            </button>
            <a href="/notes" style="background: rgba(255,255,255,0.2); color: white; padding: 1rem 2rem; border-radius: 25px; font-weight: 700; text-decoration: none; display: inline-block;">
                ❌ Annulla
            </a>
            <button type="button" onclick="deleteNote()" style="background: #EF4444; color: white; padding: 1rem 2rem; border: none; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                🗑️ Elimina
            </button>
        </div>
    </form>
</div>

<script>
    // Mostra/nascondi campi in base al tipo
    document.getElementById('note_type').addEventListener('change', function() {
        const urlGroup = document.getElementById('urlGroup');
        const dueDateGroup = document.getElementById('dueDateGroup');

        urlGroup.style.display = 'none';
        dueDateGroup.style.display = 'none';

        if (this.value === 'link') {
            urlGroup.style.display = 'block';
        } else if (this.value === 'task') {
            dueDateGroup.style.display = 'block';
        }
    });

    // Funzione elimina nota
    function deleteNote() {
        if (confirm('⚠️ Sei sicuro di voler eliminare questa nota? Questa azione non può essere annullata.')) {
            fetch('/delete_note/{{ note.id }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Nota eliminata');
                    window.location.href = '/notes';
                } else {
                    alert('❌ Errore: ' + data.message);
                }
            })
            .catch(error => {
                alert('❌ Errore di rete');
            });
        }
    }
</script>
{% endblock %}